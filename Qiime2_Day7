#!/bin/bash
#SBATCH -p batch
#SBATCH -t 120:00:00
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=20
#SBATCH --mail-user=moraesjgn@okstate.edu
#SBATCH --mail-type=end

source /scratch/moraesjg/miniconda/bin/activate
conda activate qiime2-2020.6_TensorFlow

#Importing paired-end sequences, Demultiplexing, and trimming adapters (U515F/806R)

#qiime tools import \
#  --type 'SampleData[PairedEndSequencesWithQuality]' \
#  --input-path manifest_METRITIS.txt\
#  --output-path paired-end-demux.qza \
#  --input-format PairedEndFastqManifestPhred33V2
#
#qiime demux summarize \
#  --i-data paired-end-demux.qza\
#  --o-visualization demux.qzv
#
#qiime cutadapt trim-paired\
#  --i-demultiplexed-sequences paired-end-demux.qza\
#  --p-cores 10\
#  --p-front-f GTGCCAGCMGCCGCGGTAA\
#  --p-front-r GGACTACHVGGGTWTCTAAT\
#  --p-discard-untrimmed \
#  --o-trimmed-sequences trimmed-paired-end-demux.qza
#
#qiime demux summarize\
#  --i-data trimmed-paired-end-demux.qza\
#  --o-visualization trimmed-paired-end-demux.qzv

#Sequence quality control and feature table construction using Dada2

qiime dada2 denoise-paired\
  --i-demultiplexed-seqs trimmed-paired-end-demux.qza\
  --p-trim-left-f 0\
  --p-trim-left-r 0\
  --p-trunc-len-f 162\
  --p-trunc-len-r 162\
  --o-table table.qza\
  --o-representative-sequences rep-seqs.qza\
  --o-denoising-stats denoising-stats.qza

qiime metadata tabulate \
  --m-input-file denoising-stats.qza \
  --o-visualization denoising-stats-dada2.qzv


#QIIME2 quality control to remove contaminant sequences
#qiime tools import \
#  --input-path /storage/htc/lucylab/Microbiome_data/fastq/fastq_ALL/DAY_14_Study/FINAL_PIPELINE/New_Results/162_162/  quality_control_DADA2/gg_13_8_otus/rep_set/99_otus.fasta \
#  --output-path 99_otus_sequences.qza \
#  --type 'FeatureData[Sequence]'

#qiime quality-control exclude-seqs \
#  --i-query-sequences rep-seqs.qza \
#  --i-reference-sequences 99_otus_sequences.qza\
#  --p-method vsearch \
#  --p-perc-identity 0.60 \
#  --p-perc-query-aligned 0.95 \
#  --p-threads 10 \
#  --o-sequence-hits hits.qza \
#  --o-sequence-misses misses.qza \
#  --verbose
#
#qiime feature-table filter-features \
#  --i-table table.qza \
#  --m-metadata-file misses.qza \
#  --o-filtered-table no-miss-table-dada2.qza \
#  --p-exclude-ids
#
#qiime metadata tabulate \
#  --m-input-file hits.qza\
#  --o-visualization hits.qzv
#
#qiime metadata tabulate\
#  --m-input-file misses.qza\
#  --o-visualization misses.qzv

#Sorting swab samples collected on Day7
#qiime feature-table filter-samples \
#  --i-table no-miss-table-dada2.qza\
#  --m-metadata-file POSTPARTUM_mapping_sample_key.txt\
#  --p-where "[Site]='D7'"\
#  --p-no-exclude-ids \
#  --o-filtered-table only-DAY7_no-miss-table-dada2.qza
#
#qiime feature-table filter-samples \
#  --i-table only-DAY7_no-miss-table-dada2.qza\
#  --m-metadata-file POSTPARTUM_mapping_sample_key.txt\
#  --p-where "[Cow_ID]='Cow_3489'"\
#  --p-exclude-ids \
#  --o-filtered-table NO3489_only-DAY7_no-miss-table-dada2.qza 
#
##
###FeatureTable and FeatureData summaries
#qiime feature-table summarize \
#  --i-table NO3489_only-DAY7_no-miss-table-dada2.qza\
#  --o-visualization NO3489_only-DAY7_no-miss-table-dada2.qzv\
#  --m-sample-metadata-file POSTPARTUM_mapping_sample_key.txt

#qiime feature-table tabulate-seqs \
#  --i-data rep-seqs.qza \
#  --o-visualization rep-seqs.qzv

#Generate a tree for phylogenetic diversity analyses

#qiime phylogeny align-to-tree-mafft-fasttree \
#  --i-sequences hits.qza \
#  --o-alignment aligned-rep-seqs.qza \
#  --o-masked-alignment masked-aligned-rep-seqs.qza \
#  --o-tree unrooted-tree.qza \
#  --o-rooted-tree rooted-tree.qza

#An important parameter that needs to be provided to this script is --p-sampling-depth, which is the even sampling (i.e. rarefaction) depth. Because most diversity metrics are sensitive to different sampling depths across different samples, this script will randomly subsample the counts from each sample to the value provided for this parameter. For example, if you provide --p-sampling-depth 500, this step will subsample the counts in each sample without replacement so that each sample in the resulting table has a total count of 500. If the total count for any sample(s) are smaller than this value, those samples will be dropped from the diversity analysis. Choosing this value is tricky. We recommend making your choice by reviewing the information presented in the table.qzv file that was created above. Choose a value that is as high as possible (so you retain more sequences per sample) while excluding as few samples as possible.

#qiime diversity core-metrics-phylogenetic\
#  --i-phylogeny rooted-tree.qza\
#  --i-table NO3489_only-DAY7_no-miss-table-dada2.qza\
#  --p-sampling-depth 15000\
#  --m-metadata-file POSTPARTUM_mapping_sample_key.txt\
#  --output-dir core-metrics-results

#After computing diversity metrics, we can begin to explore the microbial composition of the samples in the context of the sample metadata. This information is present in the sample metadata file that was downloaded earlier.

#We’ll first test for associations between categorical metadata columns and alpha diversity data. We’ll do that here for the Faith Phylogenetic Diversity (a measure of community richness) and evenness metrics.

#qiime diversity alpha-group-significance \
#  --i-alpha-diversity core-metrics-results/faith_pd_vector.qza \
#  --m-metadata-file POSTPARTUM_mapping_sample_key.txt\
#  --o-visualization core-metrics-results/faith-pd-group-significance.qzv
#
#qiime diversity alpha-group-significance \
#  --i-alpha-diversity core-metrics-results/evenness_vector.qza \
#  --m-metadata-file POSTPARTUM_mapping_sample_key.txt\
#  --o-visualization core-metrics-results/evenness-group-significance.qzv
#
#qiime diversity alpha-group-significance \
#  --i-alpha-diversity core-metrics-results/shannon_vector.qza\
#  --m-metadata-file POSTPARTUM_mapping_sample_key.txt\
#  --o-visualization core-metrics-results/shannon-group-significance.qzv

#Next we’ll analyze sample composition in the context of categorical metadata using PERMANOVA (first described in Anderson (2001)) using the beta-group-significance command. The following commands will test whether distances between samples within a group, such as samples from the same body site (e.g., gut), are more similar to each other then they are to samples from the other groups (e.g., tongue, left palm, and right palm). If you call this command with the --p-pairwise parameter, as we’ll do here, it will also perform pairwise tests that will allow you to determine which specific pairs of groups (e.g., tongue and gut) differ from one another, if any. This command can be slow to run, especially when passing --p-pairwise, since it is based on permutation tests. So, unlike the previous commands, we’ll run beta-group-significance on specific columns of metadata that we’re interested in exploring, rather than all metadata columns to which it is applicable. Here we’ll apply this to our unweighted UniFrac distances, using two sample metadata columns, as follows.

#qiime diversity beta-group-significance \
#  --i-distance-matrix core-metrics-results/unweighted_unifrac_distance_matrix.qza \
#  --m-metadata-file POSTPARTUM_mapping_sample_key.txt\
#  --m-metadata-column Class\
#  --o-visualization core-metrics-results/unweighted-unifrac-body-site-significance.qzv \
#  --p-pairwise
#
#qiime diversity beta-group-significance \
#  --i-distance-matrix core-metrics-results/unweighted_unifrac_distance_matrix.qza \
#  --m-metadata-file POSTPARTUM_mapping_sample_key.txt\
#  --m-metadata-column Cow_ID\
#  --o-visualization core-metrics-results/unweighted-unifrac-subject-group-significance.qzv \
#  --p-pairwise
##
#qiime diversity beta-group-significance \
#  --i-distance-matrix core-metrics-results/unweighted_unifrac_distance_matrix.qza \
#  --m-metadata-file POSTPARTUM_mapping_sample_key.txt\
#  --m-metadata-column Class\
#  --o-visualization core-metrics-results/unweighted-unifrac-Class-significance.qzv \
#  --p-pairwise
#
#qiime diversity beta-group-significance \
#  --i-distance-matrix core-metrics-results/unweighted_unifrac_distance_matrix.qza \
#  --m-metadata-file POSTPARTUM_mapping_sample_key.txt\
#  --m-metadata-column TRT\
#  --o-visualization core-metrics-results/unweighted-unifrac-TRT-group-significance.qzv \
#  --p-pairwise

#Alpha rarefaction plotting
#In this section we’ll explore alpha diversity as a function of sampling depth using the qiime diversity alpha-rarefaction visualizer. This visualizer computes one or more alpha diversity metrics at multiple sampling depths, in steps between 1 (optionally controlled with --p-min-depth) and the value provided as --p-max-depth. At each sampling depth step, 10 rarefied tables will be generated, and the diversity metrics will be computed for all samples in the tables. The number of iterations (rarefied tables computed at each sampling depth) can be controlled with --p-iterations. Average diversity values will be plotted for each sample at each even sampling depth, and samples can be grouped based on metadata in the resulting visualization if sample metadata is provided with the --m-metadata-file parameter.

#qiime diversity alpha-rarefaction \
#  --i-table NO3489_only-DAY7_no-miss-table-dada2.qza\
#  --i-phylogeny rooted-tree.qza\
#  --p-max-depth 300000\
#  --m-metadata-file POSTPARTUM_mapping_sample_key.txt\
#  --o-visualization alpha-rarefaction.qzv

#qiime feature-classifier classify-sklearn \
#  --i-classifier silva-138-99-515-806-nb-classifier.qza\
#  --i-reads hits.qza\
#  --o-classification taxonomy.qza
#
#qiime metadata tabulate \
#  --m-input-file taxonomy.qza \
#  --o-visualization taxonomy.qzv
#
#qiime taxa barplot \
#  --i-table NO3489_only-DAY7_no-miss-table-dada2.qza\
#  --i-taxonomy taxonomy.qza \
#  --m-metadata-file POSTPARTUM_mapping_sample_key.txt\
#  --o-visualization barplot-taxa-NO3489_only-DAY7_no-miss-table-dada2.qzv

#We’re also often interested in performing a differential abundance test at a specific taxonomic level. To do this, we can collapse the features in our FeatureTable[Frequency] at the taxonomic level of interest, and then re-run the above steps. In this tutorial, we collapse our feature table at the genus level (i.e. level 6 of the Greengenes taxonomy).

#qiime taxa collapse \
#  --i-table NO3489_only-DAY7_no-miss-table-dada2.qza\
#  --i-taxonomy taxonomy.qza\
#  --p-level 7\
#  --o-collapsed-table Collapsed-l6-NO3489_only-DAY7_no-miss-table-dada2.qza
#
#qiime metadata tabulate \
#  --m-input-file Collapsed-l7-NO3489_only-DAY7_no-miss-table-dada2.qza\
#  --o-visualization Collapsed-l7-NO3489_only-DAY7_no-miss-table-dada2.qzv
